.Random.seed <-
c(403L, 351L, -255867848L, -2132569278L, 1934840782L, 1073087047L, 
2107183482L, 2048907157L, -1047443283L, 635454672L, -994102563L, 
1386322652L, -699123082L, 1173174540L, 1067495611L, 859078070L, 
-1554130460L, 1235634878L, -324734565L, -929697927L, -1603001405L, 
-1859950790L, -480074888L, -1475946294L, 237633407L, 1606688442L, 
1404003115L, 148600816L, 1977225237L, -803909136L, -1481510518L, 
1500771817L, 2024093911L, -430398689L, -1297970725L, -931621741L, 
-1019765221L, 129276055L, -1846918185L, -792203866L, 2115327248L, 
1424835632L, 1239204478L, -1798305621L, 1224467495L, -1879142545L, 
-1285621578L, -1489400522L, -332986382L, -762021074L, -807414829L, 
1411128318L, -1403960885L, -1789210135L, -1190047147L, -2063461930L, 
-1382712103L, -1556362548L, -883956732L, 1261532062L, -1534655290L, 
193883080L, 1014105919L, 1297565984L, -182360544L, 1392706883L, 
965618917L, 198223566L, -1647325270L, -1975509469L, -1558003304L, 
311544630L, -1279418353L, -2024441972L, 1209066418L, -2084262107L, 
-771075906L, -460759440L, 553093187L, -106435532L, 502374816L, 
1374912193L, 103877382L, -76882740L, -1440050563L, 323659113L, 
242669505L, 111447867L, -1190794161L, 271477897L, 472599749L, 
1264923919L, -387322689L, -1615881903L, 2021757509L, -318886004L, 
-725503664L, 987132453L, 239307112L, -1356217861L, 202311156L, 
-603165896L, -207136360L, 1960347938L, 714212608L, -1169026266L, 
963223196L, -986992142L, -2062483291L, -874648732L, -2116582158L, 
162871577L, -2040647966L, 202650718L, -504283262L, -733933799L, 
-1514142213L, 1779123007L, 306652187L, -947946700L, -172670780L, 
542129363L, -216903656L, -1380072735L, -2079557415L, -244620451L, 
-797294175L, 851175420L, -159121436L, -1395377609L, 953977283L, 
-541503598L, -1214348459L, 2097620074L, 1243043220L, 858219584L, 
-1413786856L, 312941336L, 868155528L, -138952795L, 445854260L, 
1438346246L, 1369508891L, 1999990665L, 1341791532L, 1268729295L, 
1388926901L, -127278550L, 1276838238L, 1545806100L, -1624999158L, 
-733929552L, 1639283550L, 1578654035L, 1288912505L, 1738275118L, 
254995840L, 373834688L, 1419876906L, 1400174448L, -1249598893L, 
-723921303L, 1013630864L, -402288584L, -1847482931L, 1099149872L, 
-1005879442L, 1500669987L, -1410310882L, 1732967106L, 94410648L, 
-1344903962L, -1776882723L, 1499988242L, -1474872648L, -747385898L, 
709668961L, -489542587L, -1074818983L, -2055675295L, -349287988L, 
-68391861L, 1069764183L, -212956798L, -1804144452L, -2053966387L, 
-755112276L, -2026772055L, -222065712L, -1233147013L, -1481190906L, 
-1164603967L, 287329297L, -831231973L, 703378270L, -1653600537L, 
-1780233221L, 123338361L, -1469247502L, 111994625L, -1351927608L, 
-1640487553L, -1448251518L, -356973486L, 1935704278L, 1827963132L, 
1297293970L, -428129800L, -1104311026L, -1749031651L, -1597412852L, 
599871944L, 274422259L, 90583203L, 981196535L, -1000434185L, 
-1234219186L, -1564186582L, 1196246324L, -685457569L, 1692610210L, 
1074410982L, 656691152L, 1058611989L, 295210216L, -302642708L, 
-135321685L, -1188789300L, -687718537L, 1030233406L, 1877401365L, 
-1519475167L, -1461183235L, 348533347L, -506749556L, 794856390L, 
328709498L, 1243895472L, 911350017L, -613207881L, -572714760L, 
-1836119790L, 614760879L, 687543596L, 477696936L, -2127989754L, 
1172594719L, -1770496020L, 236870505L, 1118711085L, -817723756L, 
2132909690L, -1768411454L, -1128584613L, 1460298067L, -1129272807L, 
136756898L, -764382634L, 985991749L, 473519446L, -1593051604L, 
-185027359L, -14922039L, 553699057L, 503449517L, -530433542L, 
1467332275L, 2130972117L, 1565566832L, -1350177187L, 790100675L, 
-1979559549L, -546007071L, 1155225696L, 952754046L, 1359759775L, 
-1254979631L, -915284244L, 1281820297L, -1298837213L, -20656528L, 
-248305035L, 455371488L, -874256935L, 1214733867L, -381988249L, 
1329023612L, 1301664366L, 1612209100L, -1470729719L, -1208637682L, 
2121104150L, 1495957607L, -711583216L, 835272332L, -774213057L, 
-1508630106L, -1193290092L, -818575253L, -1290625530L, -174157389L, 
-782706191L, -1104695885L, 562408469L, 1827032702L, -798049725L, 
-1539544516L, 1529061789L, 1078041191L, -206990865L, -804600680L, 
1434121575L, -1987985980L, 1417878958L, -964302414L, 1974292506L, 
1123011797L, -880240297L, 1299050921L, -538439123L, -1714199932L, 
-1804889353L, 1401639406L, 1480595630L, -1953961717L, -997670213L, 
-1352649181L, -515571406L, -138317672L, -490864842L, 306123878L, 
283234638L, 1713386385L, 391848594L, -746512688L, -934594836L, 
-23784203L, -604248635L, -1025457656L, 1874180754L, 1970662653L, 
-1164120644L, 839459353L, 1332238904L, 1324063123L, -1727046790L, 
2081146815L, -305865391L, -1600613160L, -2050142286L, -1454167262L, 
1984208836L, 1608233768L, -1637273856L, 546510557L, -1977216776L, 
-1227064041L, 238433387L, 998979448L, 104334537L, 1901063527L, 
-716497643L, -52233376L, 797710784L, 612160590L, 309317908L, 
1436820227L, 1208170686L, -689724519L, 1796068046L, -1255926235L, 
1508394915L, 1882116148L, -1463048717L, 528282281L, -1230208373L, 
-1729692673L, -107041762L, -149624105L, -386271090L, -1532715981L, 
384813397L, 873867756L, -122487962L, -1875215241L, 1044917339L, 
1391433381L, -1022173102L, 1564789650L, -1018369008L, -1457642291L, 
-1903249266L, 1662684668L, -1743122274L, -108417036L, 530949819L, 
566208419L, -642065296L, 1953825942L, -1643359430L, -612799403L, 
-261341765L, -1539803613L, -999561603L, 2142239697L, -2129202907L, 
905341433L, -49740949L, 1184268404L, 1704018743L, 1760551820L, 
-1499370294L, 1431097790L, 649004052L, -562125778L, -1179858777L, 
2074605628L, -1581637775L, 1844728845L, 2103503579L, -2121687916L, 
1004297251L, 335461344L, 1748354277L, 2124047208L, -1044298869L, 
1445318711L, 827093021L, -56226331L, 1468024999L, -434566011L, 
741399664L, 302854058L, 350246267L, -186820238L, -743539224L, 
1516420376L, -1374588603L, 1246614106L, 1118147446L, -808113457L, 
934597499L, 1960052921L, 1481804014L, -1835263484L, 2118523377L, 
2121005665L, 1906608088L, -1405746409L, 1444320327L, -565880694L, 
1884841932L, -729880402L, -864449652L, 1430414945L, 834986142L, 
-620245872L, -704991886L, -1470038066L, 1667235708L, -1467824500L, 
2083873326L, 1192873493L, 1608325399L, -1608925918L, -1035636141L, 
663509488L, -1867780392L, -460280536L, -360401426L, -253898107L, 
512289619L, 1436368372L, -514408362L, -1342178890L, 2029107723L, 
1068015291L, -1977339771L, -646971364L, -2121365070L, -1355050246L, 
1379501708L, -1086571713L, 378893564L, -290885501L, -1524631325L, 
-1745559240L, -77352254L, -284434001L, -1314381807L, 470463210L, 
-30784875L, 709251334L, 1191107480L, 1017006842L, -475501903L, 
-250593932L, -2045469528L, -1339147645L, 532004420L, 525275721L, 
-706032839L, 359346383L, -305093718L, -616852445L, 1907356406L, 
-1245046749L, 1856015296L, 1874284605L, -980696244L, 485829684L, 
-30739931L, 1457166689L, 610267244L, 111129232L, 1365711350L, 
1759996744L, 1203661597L, -910131523L, -1870456254L, -1947726419L, 
145792315L, 1647612376L, 1122916664L, 1282864294L, 1082387166L, 
-1807258344L, 1515585266L, -1183151266L, 1865080081L, -1331651483L, 
-1355027315L, 499125728L, 830427292L, -1913173677L, -407793213L, 
763096315L, 1076464509L, 1793147983L, 1581124478L, 28031657L, 
591194462L, 548586770L, -704216339L, -480217671L, -1781034875L, 
-1291140742L, 243877319L, -4325500L, -1572483068L, 694170033L, 
-1085520034L, 1129751495L, -1557040830L, -275865431L, 792810264L, 
345550701L, -612494535L, -1157086871L, 744271515L, 1284064225L, 
1477442872L, -1714972109L, -1832183141L, -863060765L, -1905177559L, 
478372052L, 725681207L, -495481070L, 2014819154L, 1411773485L, 
774309900L, 1332135832L, 1050301684L, 1769215039L, 174252058L, 
908817675L, 1894289556L, -1327522280L, -396482083L, 1306081085L, 
-1706689737L, -858198015L, -744840040L, 239362433L, -943386286L, 
-1981425128L, -1360731536L, -1068190837L, -487103873L, 153176106L, 
1176568307L, 1932134822L, 1041303801L, 709480725L, -208768113L, 
510789143L, -291333647L, -1418100198L, 243509481L, -1751135240L, 
301887778L, -640211247L, 753183160L, -180130857L, -1847054648L, 
1418561677L, -158229313L, 428502978L, -554120772L, -602053603L, 
-1112009773L, -509215795L, 1258669891L, -173219135L, 1875492162L, 
1872148193L, 1028638046L, 1587722072L, -1848054915L, 936990672L, 
357905348L, -1408860715L, 774357959L, -161625552L, 1277879946L
)

.IPLBOOST.iter <- function(times, status, mat, betas, lms, w, lambdas) {
  ## Internal function that performs one iteration of the 
  ## IplBoost algorithm
  
  # Matrix of risk functions for the coefficients for each landmark point
  risk.s <- exp(mat %*% t(betas))

  # Call C++ function to compute S0 for each landmark
  S0 <- .compute_S0(as.matrix(risk.s), times, length(times), length(lms))
  
  # Call C++ functions sequentially to compute S1.j and S2.j for each
  # lanamark for each covariate j (loops over j)
  S1 <- lapply(1:dim(mat)[2], .compute_S1_j, risk=as.matrix(risk.s), times=times,
               mat=mat, n=length(times), S=length(lms))
  S_2 <- lapply(1:dim(mat)[2], .compute_S2_j, risk=as.matrix(risk.s), times=times,
                mat=mat, n=length(times), S=length(lms))
  
  # Call C++ functions to sequentially compute the first derivative and the
  # negative of the second derivative for each landmark, for each covariate j
  first.der <- lapply(1:dim(mat)[2], function(j){.compute_u_j(j, status, mat, times,
                                                          S0, S1[[j]], length(times),
                                                          length(lms), lms, w)})
  
  min.second.der <- lapply(1:dim(mat)[2], function(j){.compute_minI_j(j, status, times, S0, S1[[j]],
                                                        S2[[j]], length(times), length(lms),
                                                        lms, w, lambdas)})
  
  # Compute scores (proportional to second order Taylor expansion of the ipl)
  score.vars <- as.numeric(lapply(1:dim(mat)[2], function(j){sum(first.der[[j]]**2/min.second.der[[j]])}))
  
  # Choose the variable that maximises the approximation
  j.star <- which(score.vars == max(score.vars))
  
  # Update coefficients
  betas <- betas
  betas[, j.star] <- betas[, j.star] + first.der[[j.star]]/min.second.der[[j.star]]
  
  return(betas)
}

